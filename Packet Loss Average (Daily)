WITH 
  total AS
  (
    SELECT
      FORMAT_TIMESTAMP('%Y-%m-%d', timestamp) AS day,
      COUNT(*) as sample_count,
      COUNT(IF(next_rtt>0,1,0)) as next_sample_count,
      SUM(direct_packet_loss) as direct_packet_loss,
      SUM(IF(next_rtt>0,next_packet_loss,0)) as next_packet_loss,
      SUM(real_packet_loss) as real_packet_loss,
    FROM
      `analytics.rematch_session_update` as session_update
    WHERE
      (session_update.timestamp BETWEEN '2025-10-01 00:00:00 UTC' AND '2025-10-31 23:59:59 UTC')
    GROUP BY
      day
  )
SELECT
  day,
  SUM(direct_packet_loss)/SUM(sample_count) as direct,
  SUM(next_packet_loss)/SUM(next_sample_count) as next,
  SUM(real_packet_loss)/SUM(sample_count) as real,
FROM
  total  
GROUP BY
  day
ORDER BY
  day
